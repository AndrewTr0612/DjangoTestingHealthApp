{% extends 'base.html' %}

{% block title %}Dashboard - Health Tracker{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    .stat-card {
        border-radius: 12px;
        padding: 1.5rem;
        height: 100%;
        transition: transform 0.3s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-icon {
        font-size: 2.5rem;
        opacity: 0.8;
    }
    .progress-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: conic-gradient(
            var(--primary-color) calc(var(--progress) * 1%),
            #e9ecef calc(var(--progress) * 1%)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    .progress-circle::before {
        content: '';
        width: 90px;
        height: 90px;
        border-radius: 50%;
        background: white;
        position: absolute;
    }
    .progress-text {
        position: relative;
        z-index: 1;
        font-weight: bold;
        font-size: 1.5rem;
    }
    .timeline-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="mb-2">
                <i class="bi bi-speedometer2 text-primary"></i> 
                Welcome back, <span class="text-primary">{% if user.get_full_name %}{{ user.get_full_name }}{% elif user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}</span>!
            </h1>
            <p class="text-muted mb-0">
                <i class="bi bi-calendar3"></i> 
                {{ "now"|date:"l, F j, Y" }}
            </p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <a href="{% url 'accounts:add_weight' %}" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-circle"></i> Add Weight
            </a>
        </div>
    </div>
</div>

<!-- Stats Overview -->
<div class="row g-4 mb-4">
    <!-- Current Weight -->
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card bg-primary text-white">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="mb-1 opacity-75">Current Weight</p>
                    <h3 class="mb-0">{% if latest_weight %}{{ latest_weight.weight_kg }} kg{% else %}--{% endif %}</h3>
                </div>
                <i class="bi bi-weight stat-icon"></i>
            </div>
        </div>
    </div>
    
    <!-- BMI -->
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card bg-success text-white">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="mb-1 opacity-75">BMI</p>
                    <h3 class="mb-0">{% if latest_weight.bmi %}{{ latest_weight.bmi }}{% else %}--{% endif %}</h3>
                    {% if latest_weight.bmi %}<small class="opacity-75">{{ latest_weight.bmi_category }}</small>{% endif %}
                </div>
                <i class="bi bi-heart-pulse stat-icon"></i>
            </div>
        </div>
    </div>
    
    <!-- Target Weight -->
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card bg-info text-white">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="mb-1 opacity-75">Target Weight</p>
                    <h3 class="mb-0">{% if weight_goal %}{{ weight_goal.target_weight_kg }} kg{% else %}--{% endif %}</h3>
                    {% if weight_goal %}<small class="opacity-75">{{ weight_goal.get_goal_type_display }}</small>{% endif %}
                </div>
                <i class="bi bi-target stat-icon"></i>
            </div>
        </div>
    </div>
    
    <!-- Height -->
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card bg-warning text-white">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="mb-1 opacity-75">Height</p>
                    <h3 class="mb-0">{{ profile.height_cm }} cm</h3>
                    {% if profile.age %}<small class="opacity-75">Age: {{ profile.age }} years</small>{% endif %}
                </div>
                <i class="bi bi-rulers stat-icon"></i>
            </div>
        </div>
    </div>
</div>

<!-- Goal Progress Card -->
{% if weight_goal and timeline_data %}
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card h-100">
            <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="mb-0"><i class="bi bi-trophy"></i> Your Goal Progress</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-7">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fw-bold">Progress to Goal</span>
                                <span class="text-primary fw-bold">{{ timeline_data.progress }}%</span>
                            </div>
                            <div class="progress" style="height: 25px; border-radius: 12px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                     role="progressbar" 
                                     style="width: {{ timeline_data.progress }}%"
                                     aria-valuenow="{{ timeline_data.progress }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ timeline_data.progress }}%
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-6">
                                <div class="border rounded p-3">
                                    <small class="text-muted d-block">To Lose/Gain</small>
                                    <h5 class="mb-0 text-primary">{{ timeline_data.weight_difference }} kg</h5>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3">
                                    <small class="text-muted d-block">Weekly Rate</small>
                                    <h5 class="mb-0 text-success">{{ timeline_data.weekly_rate }} kg/week</h5>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3">
                                    <small class="text-muted d-block">Weeks Remaining</small>
                                    <h5 class="mb-0 text-info">{{ timeline_data.weeks_to_goal }} weeks</h5>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3">
                                    <small class="text-muted d-block">Target Date</small>
                                    <h5 class="mb-0 text-warning">{{ timeline_data.target_date|date:"M d" }}</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-5 text-center mt-4 mt-md-0">
                        <div class="progress-circle mx-auto" style="--progress: {{ timeline_data.progress }}">
                            <div class="progress-text">{{ timeline_data.progress }}%</div>
                        </div>
                        <p class="mt-3 mb-0 fw-bold text-primary">{{ weight_goal.get_goal_type_display }}</p>
                        <p class="text-muted small">{{ weight_goal.get_pace_display }}</p>
                    </div>
                </div>
                
                <div class="mt-3 text-center">
                    <a href="{% url 'accounts:set_goal' %}" class="btn btn-outline-primary">
                        <i class="bi bi-pencil"></i> Update Goal
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Quick Stats</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-3 pb-3 border-bottom">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Current</span>
                            <span class="fw-bold">{{ timeline_data.current_weight }} kg</span>
                        </div>
                    </li>
                    <li class="mb-3 pb-3 border-bottom">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Target</span>
                            <span class="fw-bold text-primary">{{ timeline_data.target_weight }} kg</span>
                        </div>
                    </li>
                    <li class="mb-3 pb-3 border-bottom">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">BMI</span>
                            <span class="fw-bold">{{ timeline_data.bmi }}</span>
                        </div>
                    </li>
                    <li class="mb-0">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Category</span>
                            <span class="timeline-badge bg-success text-white">{{ timeline_data.bmi_category }}</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-target" style="font-size: 4rem; color: #ddd;"></i>
                <h5 class="mt-3">No Goal Set Yet</h5>
                <p class="text-muted">Set a weight goal to start tracking your progress!</p>
                <a href="{% url 'accounts:set_goal' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Set Your Goal Now
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Weight Chart -->
{% if weight_history %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-graph-up text-primary"></i> Weight Trend</h5>
                <span class="badge bg-primary">Last 30 entries</span>
            </div>
            <div class="card-body">
                <canvas id="weightChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Weight Entries -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-ul text-secondary"></i> Recent Weight Entries</h5>
                <a href="{% url 'accounts:add_weight' %}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus"></i> Add Entry
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th><i class="bi bi-calendar3"></i> Date</th>
                                <th><i class="bi bi-weight"></i> Weight</th>
                                <th><i class="bi bi-heart-pulse"></i> BMI</th>
                                <th><i class="bi bi-tag"></i> Category</th>
                                <th><i class="bi bi-sticky"></i> Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in weight_history|slice:":10" %}
                            <tr>
                                <td>
                                    <span class="badge bg-light text-dark">
                                        {{ entry.recorded_date|date:"M d, Y" }}
                                    </span>
                                </td>
                                <td class="fw-bold">{{ entry.weight_kg }} kg</td>
                                <td>{% if entry.bmi %}{{ entry.bmi }}{% else %}N/A{% endif %}</td>
                                <td>
                                    {% if entry.bmi_category == 'Normal weight' %}
                                        <span class="badge bg-success">{{ entry.bmi_category }}</span>
                                    {% elif entry.bmi_category == 'Underweight' %}
                                        <span class="badge bg-warning">{{ entry.bmi_category }}</span>
                                    {% elif entry.bmi_category == 'Overweight' %}
                                        <span class="badge bg-info">{{ entry.bmi_category }}</span>
                                    {% elif entry.bmi_category == 'Obese' %}
                                        <span class="badge bg-danger">{{ entry.bmi_category }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ entry.bmi_category }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-muted">{{ entry.notes|truncatewords:10|default:"No notes" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-clipboard-data" style="font-size: 4rem; color: #ddd;"></i>
                <h5 class="mt-3">No Weight Entries Yet</h5>
                <p class="text-muted">Start tracking your weight to see progress charts and analytics!</p>
                <a href="{% url 'accounts:add_weight' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Your First Weight Entry
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if chart_data.dates %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('weightChart').getContext('2d');
    const weightChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_data.dates|safe }},
            datasets: [{
                label: 'Weight (kg)',
                data: {{ chart_data.weights|safe }},
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Weight (kg)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}
